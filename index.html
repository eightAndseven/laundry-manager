<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">

</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a id="brand" href="#" class="brand-logo center">Laundry Manager</a>
        </div>
    </nav>
    <div class="row">
        <h5>title</h5>
    </div>
    <div class="row">
        <div class="col s4">
            <h5>Add transaction</h5>
            <div id="transaction-columns">

            </div>
        </div>
        <div class="col s8">
            <h1>hello</h1>
        </div>
    </div>

    <div class="fixed-action-btn">
        <a class="btn-floating btn-large red">
            <i class="large material-icons">mode_edit</i>
        </a>
        <ul>
            <li><a class="btn-floating red"><i class="material-icons">insert_chart</i></a></li>
            <li><a class="btn-floating yellow darken-1"><i class="material-icons">format_quote</i></a></li>
            <li><a class="btn-floating green"><i class="material-icons">publish</i></a></li>
            <li><a class="btn-floating blue"><i class="material-icons">attach_file</i></a></li>
        </ul>
    </div>
    <!-- scripts -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="node_modules/materialize-css/dist/js/materialize.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <script>

    const electron = require('electron')
    const {ipcRenderer, remote} = electron
    let appsettings


    function getAppSettings(data){
        if (typeof data.appname !== 'undefined') {
            const brand = document.querySelector('a#brand')
            brand.innerHTML = data.appname
            document.title = data.appname
        }
    }
    
    ipcRenderer.on('user:settings', (err, data) => {
        const brand = document.querySelector('a#brand')
        brand.innerHTML = data.appname
        document.title = data.appname
        appsettings = remote.getCurrentWindow().appsettings
        transanctioncolumns()
    })

    document.addEventListener('DOMContentLoaded', e => {
        appsettings = remote.getCurrentWindow().appsettings
        getAppSettings(appsettings)
        transanctioncolumns()
    })

    function transanctioncolumns(){
        const divcolumn = document.querySelector('div#transaction-columns')
        divcolumn.innerHTML = ''
        const columns = appsettings.columns
        
        if (columns.length > 0) {
            // do it here
            const form = document.createElement('form')
            form.id = 'form-add-transaction'
            form.className = 'col s12'
            const divtransact = document.createElement('div')
            divtransact.className = 'col s12'

            let columnname = []
            let columncost = []
            columns.forEach(item => {
                if (item.column_worn === 'Name') {
                    columnname.push(item)
                } else {
                    columncost.push(item)
                }             
            })
            if (columnname.length > 0) {
                columnname.forEach(item => {
                    const rowdiv = document.createElement('div')
                    rowdiv.className = 'input-field'
                    const input = document.createElement('input')
                    input.type = 'text'
                    input.id = item.column_id
                    input.className = 'input-add-transaction-name'
                    input.setAttribute('column-type', 'name')
                    const label = document.createElement('label')
                    label.setAttribute('for', item.column_id)
                    if (item.column_require === 'Required') input.classList.add('transact-required') 
                    const required = item.column_required === 'Required' ? '*' : ''
                    label.innerHTML = item.column_name + required
                    rowdiv.appendChild(input)
                    rowdiv.appendChild(label)
                    divtransact.appendChild(rowdiv)
                })
            }
            if (columncost.length > 0) {
                columncost.forEach(item => {
                    const row = document.createElement('div')
                    row.className = 'row col s12'
                    row.style.marginBottom = '-20px'
                    const rowdiv = document.createElement('div')
                    rowdiv.className = 'input-field col s5'
                    const input = document.createElement('input')
                    input.type = 'number'
                    input.id = item.column_id
                    input.min = 0
                    input.className = 'input-add-transaction-cost number-only'
                    input.setAttribute('column-type', 'cost')
                    const label = document.createElement('label')
                    label.setAttribute('for', item.column_id)
                    if (item.column_require === 'Required') input.classList.add('transact-required') 
                    const required = item.column_require === 'Required' ? '*' : ''
                    label.innerHTML = item.column_name + required
                    rowdiv.appendChild(input)
                    rowdiv.appendChild(label)

                    const compdiv = document.createElement('div')
                    compdiv.className = 'col s3'
                    compdiv.style.paddingTop = '35px'
                    
                    // initial price per qty
                    let span = document.createElement('span')
                    span.innerHTML = 'x'
                    span.style.marginRight = '10px'
                    compdiv.appendChild(span)
                    span = document.createElement('span')
                    span.setAttribute('price-val', item.column_price)
                    span.className = 'price-init ' + item.column_id
                    span.innerHTML = item.column_price
                    compdiv.appendChild(span)
                    
                    // total
                    const divtotal = document.createElement('div')
                    divtotal.className = 'right-align col s4'
                    divtotal.style.paddingTop = '35px'
                    span = document.createElement('span')
                    span.className = 'right-align'
                    span.style.marginRight = '10px'
                    span.innerHTML = '='
                    divtotal.appendChild(span)
                    span = document.createElement('span')
                    span.className = 'price-total ' + item.column_id
                    span.innerHTML = 0
                    // appends
                    divtotal.appendChild(span)    
                    row.appendChild(rowdiv)
                    row.appendChild(compdiv)
                    row.appendChild(divtotal)
                    divtransact.appendChild(row)
                })
                // total div
                const divtot = document.createElement('div')
                divtot.className = 'row col s12'
                divtot.style.paddingTop = '16px'
                const divtotdesc = document.createElement('div')
                divtotdesc.className = 'col s8 right-align'
                divtotdesc.style.fontWeight = 'bold'
                divtotdesc.innerHTML = 'Total:'
                divtotprice = document.createElement('div')
                divtotprice.className = 'col s4 right-align'
                let spantotprice = document.createElement('span')
                spantotprice.innerHTML = 'Php '
                divtotprice.appendChild(spantotprice)
                spantotprice = document.createElement('span')
                spantotprice.id = 'total-add-transaction'
                spantotprice.style.fontWeight = 'bold'
                spantotprice.innerHTML = '0'
                divtotprice.appendChild(spantotprice)
                divtot.appendChild(divtotdesc)
                divtot.appendChild(divtotprice)
                divtransact.appendChild(divtot)


                // buttons
                const divright = document.createElement('div')
                divright.className = 'row col s12 right-align'
                divright.style.padding = '10px'
                // clear
                let a = document.createElement('a')
                a.id = 'clear-add-transaction'
                a.href = '#'
                a.className = 'waves-effect waves-teal btn-flat'
                a.style.margin = '0px 5px'
                a.innerHTML = 'Clear'
                divright.appendChild(a)
                // add
                a = document.createElement('a')
                a.id = 'add-add-transaction'
                a.href = '#'
                a.className = 'waves-effect waves-teal btn'
                a.style.margin = '0px 5px'
                a.innerHTML = 'ADD'
                divright.appendChild(a)
                divtransact.appendChild(divright)
            }
            form.appendChild(divtransact)
            divcolumn.appendChild(form)
        }
        // functions
        function computetotal() {
            const total = document.querySelector('span#total-add-transaction')
            const addends = document.querySelectorAll('span.price-total')
            let sum = 0
            addends.forEach(item => sum += parseFloat(item.innerHTML))
            total.innerHTML = sum
        }

        // Events        
        const numberonly = document.querySelectorAll('input.number-only')
        const formtransaction = document.querySelector('form#form-add-transaction')
        const canceltransaction = document.querySelector('a#clear-add-transaction')
        const addaddtransaction = document.querySelector('a#add-add-transaction')
        
        numberonly.forEach(item => item.addEventListener('keypress', e => {
            const ev = e ? e : window.event
            const code = ev.which ? ev.which : ev.keyCode
            if (code >= 48 && code <= 57){
                return ev.key
            } 
            e.preventDefault()
        }))
        numberonly.forEach(item => item.addEventListener('keyup', e => {
            const ev = e ? e : window.event
            const code = ev.which ? ev.which : ev.keyCode
            const val = e.target.value === '' ? 0 : e.target.value
            let qrys = 'span.price-init.' + e.target.id
            const price = parseFloat(document.querySelector(qrys).getAttribute('price-val'))
            qrys = 'span.price-total.' + e.target.id
            document.querySelector(qrys).innerHTML = val * price
            computetotal()
            e.preventDefault()
        }))

        formtransaction.addEventListener('submit', e => e.preventDefault())

        canceltransaction.addEventListener('click', e => {
            const form = document.querySelector('form#form-add-transaction')
            const input = form.querySelectorAll('input')
            const priceinit = form.querySelectorAll('span.price-total')
            input.forEach(item => item.value = '')
            priceinit.forEach(item => item.innerHTML = '0')
            computetotal()
            M.updateTextFields()
            e.preventDefault()
        })
        addaddtransaction.addEventListener('click', e => {
            apptransaction = remote.getGlobal('apptransactions')
            const form = document.querySelector('form#form-add-transaction')
            const input = form.querySelectorAll('input')
            // validation
            // check requried first
            let required = true
            const inputrequired = form.querySelectorAll('input.transact-required')
            inputrequired.forEach(item => {
                if (item.value === '') required = false
            })

            // if required is filled
            if (required) {
                // {
                //     name : 'string',
                //     type : 'name' | 'cost',
                //     value: 'string' | object
                // }
                let transact = []
                // submit transaction
                input.forEach(item => {
                    transact.push({
                        name : item.id,
                        type : item.getAttribute('column-type'),
                        value: item.getAttribute('column-type') === 'name' 
                            ? item.value 
                            : {
                                price : parseInt(form.querySelector('span.price-init.' + item.id).innerHTML),
                                quantity: item.value === '' 
                                    ? 0
                                    : parseInt(item.value)
                            }
                    })
                    item.value = ''
                })
                form.querySelectorAll('span.price-total').forEach(item => item.innerHTML = '0')
                computetotal()
                M.updateTextFields()

                ipcRenderer.send('transact:add', JSON.stringify(transact))
            }
            e.preventDefault()
        })
    }
    </script>
</body>
</html>